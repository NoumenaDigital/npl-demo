# NPL Demo - Walkthrough

This walkthrough demonstrates the NOUMENA Technology using the Hello World Protocol and a series of API calls. You'll:

1. Start the system and upload NPL code
2. Authenticate and get an access token
3. View user information from the JWT
4. Create an authorised instance of the Hello World protocol
5. Explore access rights to the Hello World protocol instance
6. Execute the sayHello permission as allowed and disallowed users

## Introduction

Build a complete backend API with just 21 lines of code.

**Pure business logic in NPL. Total focus on functionality. Full abstraction of ORM and API layers.**
Focus on your business logic â€” let NOUMENA handle the rest.

With this demo, you'll see how NOUMENA delivers:

- Fine-grained & contextual access control and built-in security
- Automatic persistence, transaction integrity, and error handling
- Autogenerated REST API, OpenAPI spec, and a production-ready backend

## Step 1: Setup

```sh
docker compose up -d --wait
npl deploy
```

## Step 2: Authentication

Log in to access the Hello World Protocol API. All endpoints are protected by fine-grained access control based on a JWT token.

Valid users for this demo: **alice**, **bob**, **carol** (password: `password12345678`)

```sh
# Choose a user (alice, bob, or carol)
APP_USER="bob"

echo "APP_USER: $APP_USER"
# Authenticate and get access token
RESPONSE=$(curl -s -X POST "http://localhost:11000/token" \
    -d "grant_type=password" \
    -d "username=$APP_USER" \
    -d "password=password12345678")

# Extract access token
ACCESS_TOKEN=$(echo "$RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

echo "Access token: ${ACCESS_TOKEN:0:50}..."
```

## Step 3: View User Information

User attributes are stored in the authorization token (JWT). The `preferred_username` identifies the user and will be bound to the greeter party. Other attributes can be used in NPL to build fine-grained authorization.

```sh
# Define JWT decoder function
decode_jwt() {
    local token=$1
    local payload
    payload=$(echo "$token" | cut -d'.' -f2)
    local padding=$((4 - ${#payload} % 4))
    if [ $padding -ne 4 ]; then
        payload="${payload}$(printf '=%.0s' $(seq 1 $padding))"
    fi
    echo "$payload" | base64 -d 2>/dev/null || echo "$payload" | base64 -D 2>/dev/null
}

DECODED_TOKEN=$(decode_jwt "$ACCESS_TOKEN")
echo "$DECODED_TOKEN" | jq '{iss, sub, name, preferred_username, given_name, email}'

PREFERRED_USERNAME=$(echo "$DECODED_TOKEN" | grep -o '"preferred_username":"[^"]*"' | cut -d'"' -f4)
echo "Logged in as: $PREFERRED_USERNAME"
```

## Step 4: Create an Authorised Instance of the Hello World Protocol

The [Hello World protocol](./api/src/main/npl/demo/helloWorld.npl) can be instantiated from the api thanks to the `@api` annotation on the constructor. Once instantiated, it will be persisted automatically in the database.

Create a new instance of the Hello World protocol. Your `preferred_username` will be bound to the greeter party, granting you exclusive access rights.

```sh
# Set API base URL
API_BASE="http://localhost:12000/npl/demo/HelloWorld"

# Check existing instances for this user
COUNT_RESPONSE=$(curl -s -X GET "${API_BASE}/?pageSize=1&includeCount=true" \
    -H "Authorization: Bearer $ACCESS_TOKEN")

TOTAL_ITEMS=$(echo "$COUNT_RESPONSE" | grep -o '"totalItems":[0-9]*' | cut -d':' -f2)
echo "Found ${TOTAL_ITEMS:-0} existing Hello World instance(s) for $PREFERRED_USERNAME"

# Create new protocol instance bound to the current user
CREATE_RESPONSE=$(curl -s -X POST "${API_BASE}/" \
    -H "Authorization: Bearer $ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"@parties\":{\"greeter\":{\"claims\":{\"preferred_username\":[\"$PREFERRED_USERNAME\"]}}}}")

# Extract protocol ID
PROTOCOL_ID=$(echo "$CREATE_RESPONSE" | grep -o '"@id":"[^"]*"' | cut -d'"' -f4)

echo "Protocol created with ID: $PROTOCOL_ID"
echo "Greeter party bound to: $PREFERRED_USERNAME"
echo "$CREATE_RESPONSE" | jq .
```

## Step 5: Explore Access Rights to the Hello World Protocol Instance

The protocol is now in the 'greeting' state. Let's verify that only the authorized user (the greeter party) can access it.

```sh
# View protocol details as the authorized user
echo "=== Accessing as authorized user: $PREFERRED_USERNAME ==="
curl -s -X GET "${API_BASE}/${PROTOCOL_ID}/" \
    -H "Authorization: Bearer $ACCESS_TOKEN" | jq .
```

Now let's try accessing the same protocol instance as a different user:

```sh
# Authenticate as a different user (e.g., if you created as bob, try as alice)

# TODO: Change this to a different user than $APP_USER
OTHER_USER="alice"

echo "=== Attempting access as unauthorized user: $OTHER_USER ==="
OTHER_RESPONSE=$(curl -s -X POST "http://localhost:11000/token" \
    -d "grant_type=password" \
    -d "username=$OTHER_USER" \
    -d "password=password12345678")

OTHER_TOKEN=$(echo "$OTHER_RESPONSE" | grep -o '"access_token":"[^"]*"' | cut -d'"' -f4)

# Try to access the protocol with the other user's token
curl -s -X GET "${API_BASE}/${PROTOCOL_ID}/" \
    -H "Authorization: Bearer $OTHER_TOKEN" | jq '.errorType'

# This returns a noSuchItem error
```

**Key observation:** Only the user bound to the greeter party can access this protocol instance. Other users cannot see or interact with it, demonstrating fine-grained access control.

## Step 6: Execute sayHello Permission as Allowed and Disallowed Users

Now let's execute the `sayHello` permission and see how access control works in action.

### Execute as the Authorized User

```sh
# Call sayHello permission as the authorized user
echo "=== Executing sayHello as authorized user: $PREFERRED_USERNAME ==="
HELLO_RESPONSE=$(curl -s -X POST "${API_BASE}/${PROTOCOL_ID}/sayHello" \
    -H "Authorization: Bearer $ACCESS_TOKEN" \
    -H "Content-Type: application/json")

echo "Hello response:"
echo "$HELLO_RESPONSE" | jq .
```

**Expected result:** You should receive a personalized greeting. The protocol transitions to the 'greeted' state.

### Attempt to Execute as an Unauthorized User

```sh
# Try to call sayHello with the token from another user
echo "=== Attempting sayHello as unauthorized user: $OTHER_USER ==="
UNAUTHORIZED_RESPONSE=$(curl -s -X POST "${API_BASE}/${PROTOCOL_ID}/sayHello" \
    -H "Authorization: Bearer $OTHER_TOKEN" \
    -H "Content-Type: application/json")

echo "Response from unauthorized attempt:"
echo "$UNAUTHORIZED_RESPONSE" | jq '.errorType'
```

**Expected result:** The request should fail with an access denied error or empty response, demonstrating that the permission is protected by fine-grained access control.

### Verify Final State

```sh
# Check the protocol is now in 'greeted' state and cannot be called again
echo "=== Verifying final state ==="
curl -s -X GET "${API_BASE}/${PROTOCOL_ID}/" \
    -H "Authorization: Bearer $ACCESS_TOKEN" | jq '.["@state"]'
```

## Success!

You've been greeted! The Hello World protocol has returned a greeting message tailored to you. It is now in state 'greeted' and cannot react to the sayHello permission anymore.

---

## Next Steps

- **Claim your NPL DEMO completion badge**: https://community.noumenadigital.com/t/congrats-you-have-completed-the-npl-demo/259
- **Continue your discovery journey**: https://documentation.noumenadigital.com
- **Browse the code**: https://github.com/NoumenaDigital/npl-demo
- **NPL API (Swagger)**: http://localhost:12000/

Thank you for trying the NPL Demo!
