name: integration-tests-windows

on:
  pull_request:

env:
  NPL_SERVICE_ACCOUNT_CLIENT_SECRET: "${{ secrets.NPL_SERVICE_ACCOUNT_CLIENT_SECRET }}"

jobs:
  local-runtime-windows:
    name: Docker local NOUMENA Runtime and NPL deployment (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get NPL CLI (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $apiUrl = "https://api.github.com/repos/NoumenaDigital/npl-cli/releases/latest"
          $headers = @{ "User-Agent" = "github-actions-npl-demo" }
          $release = Invoke-RestMethod -Uri $apiUrl -Headers $headers
          $asset = $release.assets | Where-Object { $_.name -match "windows" -and $_.name -match "\.exe$" } | Select-Object -First 1
          if (-not $asset) {
            throw "Unable to find Windows executable asset for the NPL CLI release."
          }

          $installDir = Join-Path $env:RUNNER_TEMP "npl-cli"
          if (-not (Test-Path $installDir)) {
            New-Item -Path $installDir -ItemType Directory | Out-Null
          }
          $exePath = Join-Path $installDir $asset.name
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $exePath

          Copy-Item -Path $exePath -Destination (Join-Path $installDir "npl.exe") -Force
          Add-Content -Path $env:GITHUB_PATH -Value $installDir
          $env:Path = "$installDir;$env:Path"
          npl version

      - name: Start NOUMENA Runtime
        shell: pwsh
        run: |
          docker compose up -d --wait

      - name: Deploy NPL locally
        shell: pwsh
        env:
          NOUMENA_SKIP_UPDATE_CHECK: "1"
        run: |
          $ErrorActionPreference = "Stop"
          $logPath = Join-Path $env:RUNNER_TEMP "npl-deploy.log"
          npl deploy | Tee-Object -FilePath $logPath
          $success = Select-String -Path $logPath -Pattern "Successfully deployed NPL sources and migrations" -Quiet
          if (-not $success) {
            throw "Expected success message not found in deployment output."
          }

      - name: Install frontend dependencies
        working-directory: webapp
        run: npm install

      - name: Run Vite dev server smoke test
        working-directory: webapp
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $logPath = Join-Path $env:RUNNER_TEMP "vite-dev.log"
          $job = Start-Job -ScriptBlock { npm run dev -- --host 127.0.0.1 --port 5173 } -InitializationScript { Set-Location $using:PWD }
          try {
            $success = $false
            foreach ($i in 1..12) {
              Start-Sleep -Seconds 5
              try {
                $response = Invoke-WebRequest -Uri "http://127.0.0.1:5173" -UseBasicParsing -TimeoutSec 5
                if ($response.StatusCode -eq 200) {
                  $success = $true
                  break
                }
              } catch {
                Out-File -FilePath $logPath -Append -InputObject $_.Exception.Message
              }
            }
            if (-not $success) {
              if (Test-Path $logPath) {
                Write-Host "===== Vite server logs ====="
                Get-Content $logPath
              }
              throw "Vite dev server did not respond with HTTP 200 within the expected time."
            }
          } finally {
            Stop-Job -Job $job -Force -ErrorAction SilentlyContinue
            Receive-Job -Job $job -ErrorAction SilentlyContinue | Out-String | Write-Output
          }

      - name: Tear down NOUMENA Runtime
        if: always()
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          docker compose down --volumes --remove-orphans

  deploy-to-cloud-windows:
    name: Deploy to NOUMENA Cloud (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get NPL CLI (Windows)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $apiUrl = "https://api.github.com/repos/NoumenaDigital/npl-cli/releases/latest"
          $headers = @{ "User-Agent" = "github-actions-npl-demo" }
          $release = Invoke-RestMethod -Uri $apiUrl -Headers $headers
          $asset = $release.assets | Where-Object { $_.name -match "windows" -and $_.name -match "\.exe$" } | Select-Object -First 1
          if (-not $asset) {
            throw "Unable to find Windows executable asset for the NPL CLI release."
          }

          $installDir = Join-Path $env:RUNNER_TEMP "npl-cli"
          if (-not (Test-Path $installDir)) {
            New-Item -Path $installDir -ItemType Directory | Out-Null
          }
          $exePath = Join-Path $installDir $asset.name
          Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $exePath

          Copy-Item -Path $exePath -Destination (Join-Path $installDir "npl.exe") -Force
          Add-Content -Path $env:GITHUB_PATH -Value $installDir
          $env:Path = "$installDir;$env:Path"
          npl version

      - name: Install frontend dependencies
        working-directory: webapp
        run: npm install

      - name: Build frontend
        working-directory: webapp
        run: npm run build

      - name: Deploy backend to NOUMENA Cloud
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          npl cloud deploy npl --tenant noumenaintegrationtests --app npldemo --migration api/src/main/migration.yml

      - name: Deploy frontend to NOUMENA Cloud
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          npl cloud deploy frontend --tenant noumenaintegrationtests --app npldemo --frontend webapp/dist

