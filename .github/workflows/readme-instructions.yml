name: Follow README Instructions

on:
  pull_request:

jobs:
  run-readme-steps:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get NPL CLI
        shell: bash
        run: |
          curl -s https://documentation.noumenadigital.com/get-npl-cli.sh | bash

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Start NOUMENA Runtime
        shell: bash
        run: |
          set -euxo pipefail
          docker compose build
          docker compose up -d --wait

      - name: Deploy NPL locally
        shell: bash
        env:
          NOUMENA_SKIP_UPDATE_CHECK: "1"
        run: |
          set -euxo pipefail
          for attempt in {1..12}; do
            if curl -fsS http://localhost:12400/health || curl -fsS http://localhost:12400 > /dev/null; then
              break
            fi
            echo "Waiting for NOUMENA Engine to become ready..."
            sleep 5
          done
          npl version
          npl deploy

      - name: Install frontend dependencies
        working-directory: webapp
        run: npm install

      - name: Run Vite dev server smoke test
        working-directory: webapp
        shell: bash
        run: |
          set -euxo pipefail
          npm run dev -- --host &
          DEV_PID=$!
          sleep 15
          kill $DEV_PID || true
          wait $DEV_PID || true

      - name: Tear down NOUMENA Runtime
        if: always()
        shell: bash
        run: |
          set -euxo pipefail
          docker compose down --volumes --remove-orphans

