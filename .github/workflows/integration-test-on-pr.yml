name: integration-tests

on:
  pull_request:

env:
  NPL_SERVICE_ACCOUNT_CLIENT_SECRET: "${{ secrets.NPL_SERVICE_ACCOUNT_CLIENT_SECRET }}"

jobs:
  deploy-to-local:
    name: Deploy to Local NOUMENA Runtime
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get NPL CLI
        shell: bash
        run: |
          set -euo pipefail
          export NPL_CLI_INSTALL_DIR="$HOME/.local/bin"
          mkdir -p "$NPL_CLI_INSTALL_DIR"
          curl -s https://documentation.noumenadigital.com/get-npl-cli.sh | bash
          echo "$NPL_CLI_INSTALL_DIR" >> "$GITHUB_PATH"
          echo "$HOME/.npl/bin" >> "$GITHUB_PATH"
          echo "$HOME/.noumena/bin" >> "$GITHUB_PATH"
          export PATH="$NPL_CLI_INSTALL_DIR:$HOME/.npl/bin:$HOME/.noumena/bin:$PATH"
          hash -r
          command -v npl >/dev/null

      - name: Start NOUMENA Runtime
        shell: bash
        run: |
          set -euxo pipefail
          docker compose build
          docker compose up -d --wait

      - name: Deploy NPL locally
        shell: bash
        env:
          NOUMENA_SKIP_UPDATE_CHECK: "1"
        run: |
          set -euo pipefail
          tmp_deploy="$(mktemp)"
          npl deploy | tee "$tmp_deploy"
          if ! grep -Fq "Successfully deployed NPL sources and migrations" "$tmp_deploy"; then
            echo "::error::Expected success message not found in deployment output."
            exit 1
          fi

      - name: Run Vite dev server smoke test
        working-directory: webapp
        shell: bash
        run: |
          success=0
          for attempt in $(seq 1 12); do
            if curl -fsS http://127.0.0.1:5173 >/dev/null; then
              success=1
              break
            fi
            sleep 5
          done

          if [ "$success" -ne 1 ]; then
            echo "::error::Vite dev server did not reach HTTP 200 within 60 seconds."
            echo "===== Vite server logs ====="
            cat "${RUNNER_TEMP}/vite-dev.log" || true
            exit 1
          fi

          trap - EXIT

      - name: Tear down NOUMENA Runtime
        shell: bash
        if: always()
        run: |
          set -euxo pipefail
          docker compose down --volumes --remove-orphans

  deploy-to-cloud:
    name: Deploy to Noumena Cloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get NPL CLI
        shell: bash
        run: |
          set -euo pipefail
          export NPL_CLI_INSTALL_DIR="$HOME/.local/bin"
          mkdir -p "$NPL_CLI_INSTALL_DIR"
          curl -s https://documentation.noumenadigital.com/get-npl-cli.sh | bash
          echo "$NPL_CLI_INSTALL_DIR" >> "$GITHUB_PATH"
          echo "$HOME/.npl/bin" >> "$GITHUB_PATH"
          echo "$HOME/.noumena/bin" >> "$GITHUB_PATH"
          export PATH="$NPL_CLI_INSTALL_DIR:$HOME/.npl/bin:$HOME/.noumena/bin:$PATH"
          hash -r
          command -v npl >/dev/null

      - name: Build frontend
        working-directory: webapp
        shell: bash
        run: |
          docker compose run --build webapp-dist

      - name: deploy backend to NOUMENA Cloud
        shell: bash
        run: |
          npl cloud deploy npl --tenant noumenaintegrationtests --app npldemo --migration api/src/main/migration.yml

      - name: deploy frontend to NOUMENA Cloud
        shell: bash
        run: |
          npl cloud deploy frontend --tenant noumenaintegrationtests --app npldemo --frontend webapp/dist